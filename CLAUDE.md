# Table2Image Multi-Agent System - 项目上下文

## 1. 项目使命
构建一个强大的表格问答系统，专门用于处理**半结构化和非结构化数据**（例如：复杂的 Excel 截图、PDF 财务报告）。
**核心理念**：使用"视觉感知"来解决纯文本模型无法处理的结构歧义，并使用"视觉压缩"来减少上下文长度。

## 2. 核心架构：两阶段视觉工作流
我们**不**使用传统的 Text-to-SQL 模式映射。我们使用涉及专门的视觉语言模型（Glyph）的**侦察与狙击**模式。

### 工作流程
1.  **阶段 1：视觉侦察兵 (Visual Scout)**
    * **输入**：原始图像。
    * **角色**：全局扫描。
    * **输出**："视觉摘要"（visual_summary），描述表格层次结构、标题和数据块布局。**暂时不包含具体数据值**。
    * **目的**：为指挥官解决"冷启动"问题。

2.  **阶段 2：指挥官 (Planner)**
    * **输入**：用户问题 + 视觉摘要。
    * **角色**：逻辑分解。
    * **输出**：具体的定位指令（例如："找到'R&D部门'行和'2023年Q1-Q4'列"）。

3.  **阶段 3：视觉狙击手 (Visual Sniper)**
    * **输入**：原始图像 + 定位指令。
    * **角色**：精确提取。
    * **输出**：一个**"数据包"**，包含：
        * 视觉确认（边界框/裁剪）。
        * **粗略 Markdown OCR**：仅针对目标数据区域的文本表示。结构准确性 > 字符准确性。

4.  **阶段 4：执行者 (Coder)**
    * **输入**：数据包 + 计算任务。
    * **角色**：逻辑执行。
    * **行动**：基于粗略 Markdown 生成 Python/SQL 代码来计算最终答案。

## 3. 关键策略：结构-内容分离
* **图像权威性**：信任图像用于*结构*（对齐、层次结构、合并单元格）。
* **文本辅助性**：使用粗略 OCR 文本用于*内容*（字符搜索/计算）。
* **处理脏数据**：我们接受 OCR 文本可能存在结构错位。系统依靠图像上下文来纠正逻辑理解。

## 4. 开发指南
* **技术栈**：Python 3.12+、`uv`、`pytest`。
* **架构**：`src` 布局（`src/table2image_agent`）。
* **方法论**：
    * **严格 TDD**：在实现*之前*在 `tests/` 中编写测试。
    * **模块化设计**：将智能体（侦察兵、指挥官、狙击手、执行者）构建为解耦的模块。
    * **类型提示**：所有函数签名强制要求类型提示。

## 5. 命令
* **测试**：`uv run pytest`
* **运行**：`uv run python src/main.py`（待定）
* **安装**：`uv add [package]` / `uv add --dev [package]`